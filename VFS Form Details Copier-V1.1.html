<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Document Legalization Form Details</title>
</head>
<body>
    <div>
        <div>
            <h3>Document Legalization Form Details</h3>
            <div style="margin-bottom: 15px;">
                <button id="loadButton">Load Form Data</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
        </div>
        <hr>
        <div>
            <form id="documentForm" onsubmit="return false;">
                <div>
                    <div>
                        <label for="email"><strong>Email Id*</strong></label>
                        <input type="email" id="email" name="email" required>
                        <button type="button" onclick="selectField('email')">Select</button>
                        <button type="button" onclick="copyToClipboard('email')">Copy</button>
                    </div>
                </div>
                <br>
                <div>
                    <label for="surname"><strong>Surname*</strong></label>
                    <input type="text" id="surname" name="surname" required>
                    <button type="button" onclick="selectField('surname')">Select</button>
                    <button type="button" onclick="copyToClipboard('surname')">Copy</button>
                </div>
                <br>
                <div>
                    <label for="otherNames"><strong>Other Names*</strong></label>
                    <input type="text" id="otherNames" name="otherNames" required>
                    <button type="button" onclick="selectField('otherNames')">Select</button>
                    <button type="button" onclick="copyToClipboard('otherNames')">Copy</button>
                </div>
                <br>
                <div>
                    <div>
                        <label><strong>Date Of Birth*</strong></label>
                        <select id="dobDay" name="dobDay" required>
                            <option value="" disabled selected>Day</option>
                        </select>
                        <select id="dobMonth" name="dobMonth" required>
                            <option value="" disabled selected>Month</option>
                        </select>
                        <select id="dobYear" name="dobYear" required>
                            <option value="" disabled selected>Year</option>
                        </select>
                    </div>
                    <br>
                    <div>
                        <label for="passportNo"><strong>Passport No*</strong></label>
                        <input type="text" id="passportNo" name="passportNo" required>
                        <button type="button" onclick="selectField('passportNo')">Select</button>
                        <button type="button" onclick="copyToClipboard('passportNo')">Copy</button>
                    </div>
                </div>
                <br>
                <div>
                    <div>
                        <label><strong>Passport Expiry Date*</strong></label>
                        <select id="expDay" name="expDay" required>
                            <option value="" disabled selected>Day</option>
                        </select>
                        <select id="expMonth" name="expMonth" required>
                            <option value="" disabled selected>Month</option>
                        </select>
                        <select id="expYear" name="expYear" required>
                            <option value="" disabled selected>Year</option>
                        </select>
                    </div>
                    <br>
                    <div>
                        <label for="gender"><strong>Gender*</strong></label>
                        <select name="gender" id="gender">
                            <option value="">--</option>
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                    </div>
                </div>
                <br>
                <div>
                    <div>
                        <label for="nationality"><strong>Nationality*</strong></label>
                        <input type="text" id="nationality" name="nationality" required>
                    </div>
                    <br>
                    <div>
                        <div>
                            <label for="primaryPhone" style="color: blue;"><strong>Primary Phone*</strong></label>
                            <input type="text" id="primaryPhone" name="primaryPhone" placeholder="7XXXXXXXXX" required>
                            <button type="button" onclick="selectField('primaryPhone')">Select</button>
                            <button type="button" onclick="copyToClipboard('primaryPhone')">Copy</button>
                        </div>
                        <br>
                        <div>
                            <label for="secondaryPhone" style="color: blue;"><strong>Secondary Phone*</strong></label>
                            <input type="text" id="secondaryPhone" name="secondaryPhone" placeholder="7XXXXXXXXX">
                            <button type="button" onclick="selectField('secondaryPhone')">Select</button>
                            <button type="button" onclick="copyToClipboard('secondaryPhone')">Copy</button>
                        </div>
                    </div>
                </div>
                <br>
                <div>
                    <div>
                        <label for="nationalId"><strong>National ID No</strong></label>
                        <input type="text" id="nationalId" name="nationalId">
                        <button type="button" onclick="selectField('nationalId')">Select</button>
                        <button type="button" onclick="copyToClipboard('nationalId')">Copy</button>
                    </div>
                    <br>
                    <div>
                        <label for="placeOfBirth"><strong>Place of Birth*</strong></label>
                        <input type="text" id="placeOfBirth" name="placeOfBirth" required>
                        <button type="button" onclick="selectField('placeOfBirth')">Select</button>
                        <button type="button" onclick="copyToClipboard('placeOfBirth')">Copy</button>
                    </div>
                </div>
                <br>
                <div>
                    <div>
                        <label for="countryOfBirth"><strong>Country of Birth*</strong></label>
                        <input type="text" id="countryOfBirth" name="countryOfBirth" required>
                    </div>
                    <br>
                    <div>
                        <label for="maritalStatus"><strong>Marital Status*</strong></label>
                        <select name="maritalStatus" id="maritalStatus">
                            <option value="">--</option>
                            <option>Single</option>
                            <option>Married</option>
                        </select>
                    </div>
                </div>
                <br>
                <div>
                    <div>
                        <label for="deliveryAddress"><strong>Delivery Address*</strong></label>
                        <input type="text" id="deliveryAddress" name="deliveryAddress" required>
                        <button type="button" onclick="selectField('deliveryAddress')">Select</button>
                        <button type="button" onclick="copyToClipboard('deliveryAddress')">Copy</button>
                    </div>
                </div>
                <br>
                <div>
                    <div>
                        <label for="delegateName" style="color: blue;"><strong>Delegate Name</strong></label>
                        <input type="text" id="delegateName" name="delegateName">
                        <button type="button" onclick="selectField('delegateName')">Select</button>
                        <button type="button" onclick="copyToClipboard('delegateName')">Copy</button>
                    </div>
                    <br>
                    <div>
                        <label for="delegatePassport"><strong>Delegate Passport Number</strong></label>
                        <input type="text" id="delegatePassport" name="delegatePassport">
                        <button type="button" onclick="selectField('delegatePassport')">Select</button>
                        <button type="button" onclick="copyToClipboard('delegatePassport')">Copy</button>
                    </div>
                </div>
                <br>
                <div>
                    <div>
                        <label for="delegateNationalId"><strong>Delegate National ID Number</strong></label>
                        <input type="text" id="delegateNationalId" name="delegateNationalId">
                        <button type="button" onclick="selectField('delegateNationalId')">Select</button>
                        <button type="button" onclick="copyToClipboard('delegateNationalId')">Copy</button>
                    </div>
                </div>
                <div>
                    <h3><strong>Select the documents to be legalized</strong></h3>
                    <div>
                        <div>
                            <input type="checkbox" id="birthCert" name="documents" value="Birth Certificate">
                            <label for="birthCert"><strong>Birth Certificate</strong></label>
                        </div>
                        <div>
                            <input type="checkbox" id="marriageCert" name="documents" value="Marriage Certificate">
                            <label for="marriageCert"><strong>Marriage Certificate</strong></label>
                        </div>
                        <div>
                            <input type="checkbox" id="policeCert" name="documents" value="Police Certificate">
                            <label for="policeCert"><strong>Police Certificate</strong></label>
                        </div>
                        <div>
                            <input type="checkbox" id="gramaCert" name="documents" value="Grama Niladhari Certificate">
                            <label for="gramaCert"><strong>Grama Niladhari Certificate</strong></label>
                        </div>
                    </div>
                </div>
                <div>
                    <h3><strong>Payment Details</strong></h3>
                    <div>
                        <div>
                            <label for="cardNumber"><strong>Card Number*</strong></label>
                            <input type="text" id="cardNumber" name="cardNumber" required>
                            <button type="button" onclick="selectField('cardNumber')">Select</button>
                            <button type="button" onclick="copyToClipboard('cardNumber')">Copy</button>
                        </div>
                        <br>
                        <div>
                            <label for="cardName"><strong>Card Name*</strong></label>
                            <input type="text" id="cardName" name="cardName" required>
                            <button type="button" onclick="selectField('cardName')">Select</button>
                            <button type="button" onclick="copyToClipboard('cardName')">Copy</button>
                        </div>
                        <br>
                        <div>
                            <label><strong>Expire Date*</strong></label>
                            <select id="expireMonth" name="expireMonth" required>
                                <option value="">Month</option>
                            </select>
                            <select id="expireYear" name="expireYear" required>
                                <option value="">Year</option>
                            </select>
                        </div>
                        <br>
                        <div>
                            <label for="cvc"><strong>CVC Number*</strong></label>
                            <input type="text" id="cvc" name="cvc" required>
                            <button type="button" onclick="selectField('cvc')">Select</button>
                            <button type="button" onclick="copyToClipboard('cvc')">Copy</button>
                        </div>
                    </div>
                </div>

                <br>
                <hr>
                <div>
                    <label for="filename"><strong>Filename*</strong></label>
                    <input type="text" id="filename" name="filename" required>
                </div>

                <div style="margin-top: 20px;">
                    <button type="button" id="downloadButton" disabled>Download Form Data</button>
                </div>
            </form>
        </div>
    </div>

    <div id="successMessage" style="display:none;">
        Text copied to clipboard!
    </div>
    <div id="loadSuccess" style="display:none; background-color: #dff0d8; padding: 10px; margin-top: 10px;">
        Form data loaded successfully!
    </div>

    <script>
        /* ---------- helpers to populate select boxes ---------- */
        function populateDateSelectors(dayId, monthId, yearId, startYear, endYear) {
            const daySelect = document.getElementById(dayId);
            const monthSelect = document.getElementById(monthId);
            const yearSelect = document.getElementById(yearId);

            // remove existing options except first placeholder
            while (daySelect.options.length > 1) daySelect.remove(1);
            while (monthSelect.options.length > 1) monthSelect.remove(1);
            while (yearSelect.options.length > 1) yearSelect.remove(1);

            for (let d = 1; d <= 31; d++) {
                const opt = document.createElement('option');
                opt.value = String(d);
                opt.textContent = String(d);
                daySelect.appendChild(opt);
            }

            const months = [
                'January','February','March','April','May','June',
                'July','August','September','October','November','December'
            ];
            months.forEach((m, index) => {
                const opt = document.createElement('option');
                opt.value = String(index + 1);
                opt.textContent = m;
                monthSelect.appendChild(opt);
            });

            const increment = startYear <= endYear ? 1 : -1;
            for (let y = startYear; (increment > 0 ? y <= endYear : y >= endYear); y += increment) {
                const opt = document.createElement('option');
                opt.value = String(y);
                opt.textContent = String(y);
                yearSelect.appendChild(opt);
            }
        }

        function populateExpirationDate(monthId, yearId, startYear, endYear) {
            const monthSelect = document.getElementById(monthId);
            const yearSelect = document.getElementById(yearId);

            while (monthSelect.options.length > 1) monthSelect.remove(1);
            while (yearSelect.options.length > 1) yearSelect.remove(1);

            for (let m = 1; m <= 12; m++) {
                const opt = document.createElement('option');
                const monthValue = m < 10 ? '0' + m : String(m);
                opt.value = monthValue;
                opt.textContent = monthValue;
                monthSelect.appendChild(opt);
            }

            for (let y = startYear; y <= endYear; y++) {
                const opt = document.createElement('option');
                opt.value = String(y);
                opt.textContent = String(y);
                yearSelect.appendChild(opt);
            }
        }

        /* ---------- select and copy helpers ---------- */
        function selectField(id) {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                try {
                    el.focus();
                    if (typeof el.select === 'function') {
                        el.select();
                    } else if (typeof el.setSelectionRange === 'function') {
                        el.setSelectionRange(0, el.value.length);
                    }
                } catch (e) {
                    console.error('Select failed for', id, e);
                }
                return;
            }

            if (el.tagName === 'SELECT') {
                try { el.focus(); } catch (e) { console.error(e); }
                return;
            }

            try {
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            } catch (e) {
                console.error('Selecting node contents failed for', id, e);
            }
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            if (!el) return;

            let text = '';
            if (el.tagName === 'SELECT') {
                const selIndex = el.selectedIndex;
                text = selIndex >= 0 ? el.options[selIndex].text : '';
            } else {
                text = el.value || el.textContent || '';
            }

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(showMessage).catch(fallbackCopy);
            } else {
                fallbackCopy();
            }

            function fallbackCopy() {
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                tempInput.style.position = 'fixed';
                tempInput.style.top = '-1000px';
                tempInput.style.left = '-1000px';
                document.body.appendChild(tempInput);
                tempInput.focus();
                tempInput.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) showMessage();
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
                document.body.removeChild(tempInput);
            }
        }

        function showMessage() {
            const msg = document.getElementById('successMessage');
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 2000);
        }

        /* ---------- file load / populate ---------- */
        function loadFormData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);
                    populateForm(parsed);

                    const loadSuccess = document.getElementById('loadSuccess');
                    loadSuccess.style.display = 'block';
                    setTimeout(() => loadSuccess.style.display = 'none', 3000);
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Helper to attempt multiple candidate paths (supports nested like "dateOfBirth.day")
        function getValFromPaths(obj, candidates) {
            for (const key of candidates) {
                if (!key) continue;
                const parts = key.split('.');
                let cur = obj;
                let ok = true;
                for (const p of parts) {
                    if (cur && Object.prototype.hasOwnProperty.call(cur, p)) {
                        cur = cur[p];
                    } else {
                        ok = false;
                        break;
                    }
                }
                if (ok) return cur;
            }
            return undefined;
        }

        function setSelectValueFlexible(selectId, value) {
            if (value === undefined || value === null || value === '') return;
            const select = document.getElementById(selectId);
            for (let i = 0; i < select.options.length; i++) {
                const opt = select.options[i];
                if (opt.value == value || opt.text == value) {
                    select.selectedIndex = i;
                    return;
                }
            }
            // if not found, leave as-is
        }

        function populateForm(data) {
            // text / simple inputs (attempt nested and flat variants)
            const mapText = {
                email: ['email', 'applicant.email'],
                surname: ['surname', 'applicant.surname'],
                otherNames: ['otherNames', 'applicant.otherNames'],
                passportNo: ['passportNo', 'passport.passportNo', 'applicant.passportNo'],
                nationality: ['nationality', 'applicant.nationality'],
                primaryPhone: ['primaryPhone', 'applicant.primaryPhone'],
                secondaryPhone: ['secondaryPhone', 'applicant.secondaryPhone'],
                nationalId: ['nationalId', 'applicant.nationalId'],
                placeOfBirth: ['placeOfBirth', 'applicant.placeOfBirth'],
                countryOfBirth: ['countryOfBirth', 'applicant.countryOfBirth'],
                deliveryAddress: ['deliveryAddress', 'contact.deliveryAddress'],
                delegateName: ['delegate.name', 'delegateName'],
                delegatePassport: ['delegate.passport', 'delegatePassport'],
                delegateNationalId: ['delegate.nationalId', 'delegateNationalId'],
                cardNumber: ['payment.cardNumber', 'cardNumber'],
                cardName: ['payment.cardName', 'cardName'],
                cvc: ['payment.cvc', 'cvc']
            };

            for (const [fieldId, candidates] of Object.entries(mapText)) {
                const val = getValFromPaths(data, candidates);
                if (val !== undefined) {
                    const el = document.getElementById(fieldId);
                    if (el) el.value = val;
                }
            }

            // date of birth
            const dobDay = getValFromPaths(data, ['dateOfBirth.day', 'dobDay']);
            const dobMonth = getValFromPaths(data, ['dateOfBirth.month', 'dobMonth']);
            const dobYear = getValFromPaths(data, ['dateOfBirth.year', 'dobYear']);
            setSelectValueFlexible('dobDay', dobDay);
            setSelectValueFlexible('dobMonth', dobMonth);
            setSelectValueFlexible('dobYear', dobYear);

            // passport expiry
            const expDay = getValFromPaths(data, ['passportExpiry.day', 'expDay']);
            const expMonth = getValFromPaths(data, ['passportExpiry.month', 'expMonth']);
            const expYear = getValFromPaths(data, ['passportExpiry.year', 'expYear']);
            setSelectValueFlexible('expDay', expDay);
            setSelectValueFlexible('expMonth', expMonth);
            setSelectValueFlexible('expYear', expYear);

            // gender & marital status (match by text or value)
            const genderVal = getValFromPaths(data, ['gender', 'applicant.gender']);
            if (genderVal !== undefined) setSelectValueFlexible('gender', genderVal);
            const maritalVal = getValFromPaths(data, ['maritalStatus', 'maritalStatus']);
            if (maritalVal !== undefined) setSelectValueFlexible('maritalStatus', maritalVal);

            // payment expire month/year
            const payExpireMonth = getValFromPaths(data, ['payment.expireMonth', 'expireMonth']);
            const payExpireYear = getValFromPaths(data, ['payment.expireYear', 'expireYear']);
            setSelectValueFlexible('expireMonth', payExpireMonth);
            setSelectValueFlexible('expireYear', payExpireYear);

            // documents (checkboxes)
            const docs = getValFromPaths(data, ['documents', 'selectedDocuments', 'documentsSelected']);
            const checkboxes = {
                'birthCert': 'Birth Certificate',
                'marriageCert': 'Marriage Certificate',
                'policeCert': 'Police Certificate',
                'gramaCert': 'Grama Niladhari Certificate'
            };
            for (const [id, value] of Object.entries(checkboxes)) {
                const cb = document.getElementById(id);
                if (!cb) continue;
                if (Array.isArray(docs) && docs.includes(value)) {
                    cb.checked = true;
                } else {
                    // also support object forms like { "Birth Certificate": true }
                    if (docs && typeof docs === 'object' && docs[value]) {
                        cb.checked = true;
                    } else {
                        // fallback flat keys in JSON: documentsBirthCertificate: true
                        cb.checked = false;
                    }
                }
            }
        }

        /* ---------- collect & download (structured & ordered) ---------- */
        function collectFormDataStructured() {
            // Build object in the same visual order as the page.
            // Using an object literal preserves insertion order in modern JS engines.
            const obj = {
                // top-level applicant details in page order
                email: document.getElementById('email').value || '',
                surname: document.getElementById('surname').value || '',
                otherNames: document.getElementById('otherNames').value || '',
                dateOfBirth: {
                    day: document.getElementById('dobDay').value || '',
                    month: document.getElementById('dobMonth').value || '',
                    year: document.getElementById('dobYear').value || ''
                },
                passportNo: document.getElementById('passportNo').value || '',
                passportExpiry: {
                    day: document.getElementById('expDay').value || '',
                    month: document.getElementById('expMonth').value || '',
                    year: document.getElementById('expYear').value || ''
                },
                gender: (function() {
                    const sel = document.getElementById('gender');
                    return sel && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex].text : '';
                })(),
                nationality: document.getElementById('nationality').value || '',
                primaryPhone: document.getElementById('primaryPhone').value || '',
                secondaryPhone: document.getElementById('secondaryPhone').value || '',
                nationalId: document.getElementById('nationalId').value || '',
                placeOfBirth: document.getElementById('placeOfBirth').value || '',
                countryOfBirth: document.getElementById('countryOfBirth').value || '',
                maritalStatus: (function() {
                    const sel = document.getElementById('maritalStatus');
                    return sel && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex].text : '';
                })(),
                deliveryAddress: document.getElementById('deliveryAddress').value || '',
                delegate: {
                    name: document.getElementById('delegateName').value || '',
                    passport: document.getElementById('delegatePassport').value || '',
                    nationalId: document.getElementById('delegateNationalId').value || ''
                },
                documents: (function() {
                    const arr = [];
                    const checked = document.querySelectorAll('input[name="documents"]:checked');
                    checked.forEach(c => arr.push(c.value));
                    return arr;
                })(),
                payment: {
                    cardNumber: document.getElementById('cardNumber').value || '',
                    cardName: document.getElementById('cardName').value || '',
                    expireMonth: document.getElementById('expireMonth').value || '',
                    expireYear: document.getElementById('expireYear').value || '',
                    cvc: document.getElementById('cvc').value || ''
                }
            };

            return obj;
        }

        function downloadFormData() {
            const filenameInput = document.getElementById('filename');
            const filename = filenameInput.value.trim();
            if (filename === '') {
                alert('Please enter a filename.');
                return;
            }
            let downloadFilename = filename;
            if (!downloadFilename.toLowerCase().endsWith('.json')) {
                downloadFilename += '.json';
            }

            const structured = collectFormDataStructured();

            // stringify with 2-space indentation for neat formatting
            const jsonData = JSON.stringify(structured, null, 2);

            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = downloadFilename;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        /* ---------- init on DOM ready ---------- */
        window.addEventListener('DOMContentLoaded', () => {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();

            populateDateSelectors('dobDay', 'dobMonth', 'dobYear', 1900, currentYear);
            populateDateSelectors('expDay', 'expMonth', 'expYear', currentYear, currentYear + 10);
            populateExpirationDate('expireMonth', 'expireYear', currentYear, currentYear + 10);

            document.getElementById('loadButton').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', loadFormData);

            const downloadButton = document.getElementById('downloadButton');
            downloadButton.addEventListener('click', downloadFormData);

            const filenameInput = document.getElementById('filename');
            filenameInput.addEventListener('input', function() {
                const value = filenameInput.value.trim();
                downloadButton.disabled = value === '';
            });
        });
    </script>
</body>
</html>
